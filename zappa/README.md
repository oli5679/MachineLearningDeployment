# Serverless Python with Zappa

This template demonstrates how to make a simple REST API with Python running on AWS Lambda and API Gateway using 'Zappa'

https://github.com/Miserlou/Zappa

Based on this guide https://towardsdatascience.com/how-to-deploy-a-machine-learning-model-on-aws-lambda-24c36dcaed20

## Prerequisites

AWS account

Create the model artefact (see 'fit-model') and copy over to .bin

## Create and activate virtual-env

    pip install virtualenv
    virtualenv zappa_test
    source zappa_api/bin/activate
    pip install -r requirements.txt

## Run Flask app

    export FLASK_APP=server.py
    flask run

## Test flask App

    curl --location --request POST 'http://127.0.0.1:5000/' \
    --header 'Content-Type: application/json' \
    --data-raw '{"input": [{"Male": 0, "Age": 21, "SibSp": 0, "Parch": 0, "Fare": 21.5}]}'

## Deploy to AWS

change zappa_settings.json to

    environment --> dev
    app_function --> server.app

    zappa init

Change zappa_settings.json to --> "slim_handler": true (this gets around maximum bundle size)

    zappa deploy dev

The same curl command will test, but with the deployed app url

    zappa update dev

## add api key

change zappa_settings.json to

     "api_key_required": true

I manually created a 'usage-plan' in API gateway (adding API and stage for Zappa app and configuring method throttling for the '/' endpoint)

I then added the api key generated by Zappa to this usage plan. Finally I changed the curl command to:

    curl --location --request POST 'ZAPPA_URL' \
    --header 'Content-Type: application/json' \
    --header 'x-api-key: API_KEY' \
    --data-raw '{"input": [{"Male": 0, "Age": 21, "SibSp": 0, "Parch": 0, "Fare": 21.5}]}'